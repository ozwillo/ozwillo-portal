var converter=new Showdown.converter({extensions:["table"]}),AppStore=React.createClass({displayName:"AppStore",componentDidMount:function(){this.updateApps(!0,!0,!0,!0,!0)},getInitialState:function(){return{defaultApp:null,apps:[],loading:!0,maybeMoreApps:!1,filter:{audience:{citizens:!0,publicbodies:!0,companies:!0},payment:{paid:!0,free:!0}}}},mergeAppsWithDefaultAppFirst:function(){return this.state.defaultApp?$.merge([this.state.defaultApp],$.map(this.state.apps,function(app){return app.id!=this.state.defaultApp.id?app:void 0}.bind(this))):this.state.apps},updateApps:function(target_citizens,target_publicbodies,target_companies,paid,free){if(default_app)$.ajax({url:store_service+"/application/"+default_app.type+"/"+default_app.id,type:"get",dataType:"json",success:function(data){default_app=null;var state=this.state;state.defaultApp=data,state.defaultApp.isDefault=!0,this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)});else{var state=this.state;state.defaultApp=null,this.setState(state)}var supported_locales=[];"all"!==this.refs.sideBar.state.selectedLanguage&&supported_locales.push(this.refs.sideBar.state.selectedLanguage);var geographicalAreaUris=this.refs.sideBar.refs.geoSearch.state.value,searchText=this.refs.sideBar.state.searchText,queryParams={target_citizens:target_citizens,target_publicbodies:target_publicbodies,target_companies:target_companies,free:free,paid:paid,supported_locales:supported_locales,geographical_areas:geographicalAreaUris,category_ids:[],q:searchText};$.ajax({url:store_service+"/applications",data:queryParams,traditional:!0,type:"get",dataType:"json",success:function(data){this.setState({apps:data.apps,maybeMoreApps:data.maybeMoreApps,loading:!1,filter:{audience:{citizens:target_citizens,publicbodies:target_publicbodies,companies:target_companies},payment:{free:free,paid:paid}}})}.bind(this),error:function(xhr,status,err){this.setState({apps:[],loading:!1})}.bind(this)})},loadMoreApps:function(){var state=this.state;state.loading=!0,this.setState(state),$.ajax({url:store_service+"/applications",data:{last:this.state.apps.length,target_citizens:this.state.filter.audience.citizens,target_publicbodies:this.state.filter.audience.publicbodies,target_companies:this.state.filter.audience.companies,free:this.state.filter.payment.free,paid:this.state.filter.payment.paid},type:"get",dataType:"json",success:function(data){var state=this.state;state.apps=state.apps.concat(data.apps),state.loading=!1,state.maybeMoreApps=data.maybeMoreApps,this.setState(state)}.bind(this),error:function(){var state=this.state;state.loading=!1,state.maybeMoreApps=!1,this.setState(state)}.bind(this)})},render:function(){var languagesAndAll=JSON.parse(JSON.stringify(languages));languagesAndAll.unshift("all");var initialSelectedLanguage=currentLanguage;return React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement(SideBar,{ref:"sideBar",currentLanguage:initialSelectedLanguage,languages:languagesAndAll,updateApps:this.updateApps,filter:this.state.filter}),React.createElement(AppList,{apps:this.mergeAppsWithDefaultAppFirst()})),React.createElement("div",{className:"row"},React.createElement(LoadMore,{loading:this.state.loading,maybeMoreApps:this.state.maybeMoreApps,loadMoreApps:this.loadMoreApps})))}}),SideBar=React.createClass({displayName:"SideBar",getInitialState:function(){return{selectedLanguage:"en",geographicalAreaUris:[],searchText:""}},componentDidMount:function(){var s=this.state;s.selectedLanguage=this.props.currentLanguage,this.setState(s)},handleLanguageClicked:function(language){var s=this.state;s.selectedLanguage=language,this.setState(s),this.search()},fullTextSearchChanged:function(event){var s=this.state;s.searchText=event.target.value,this.setState(s)},search:function(){var filter=this.props.filter;this.props.updateApps(filter.audience.citizens,filter.audience.publicbodies,filter.audience.companies,filter.payment.paid,filter.payment.free)},change:function(category,item){return function(){var canChange=!1;for(var i in this.props.filter[category])if(i!=item&&1==this.props.filter[category][i]){canChange=!0;break}if(canChange){var filter=this.props.filter;filter[category][item]=!filter[category][item],this.props.updateApps(filter.audience.citizens,filter.audience.publicbodies,filter.audience.companies,filter.payment.paid,filter.payment.free)}}.bind(this)},render:function(){var languageComponents=this.props.languages.map(function(language){return React.createElement("li",null,React.createElement("a",{onClick:this.handleLanguageClicked.bind(this,language),href:"#"},t(language)))}.bind(this));return React.createElement("div",{className:"col-md-4 sidebar"},React.createElement("h2",null,React.createElement("img",{src:image_root+"my/app-store.png"})," ",t("ui.appstore")),React.createElement("div",{className:"locale-filter"},React.createElement("span",null,t("languages-supported-by-applications")),React.createElement("div",{className:"btn-group"},React.createElement("button",{type:"button",className:"btn btn-sm btn-default dropdown-toggle","data-toggle":"dropdown","aria-expanded":"false"},React.createElement("span",null,t(this.state.selectedLanguage))," ",React.createElement("span",{className:"caret"})),React.createElement("ul",{className:"dropdown-menu",role:"menu"},languageComponents))),React.createElement("div",null,React.createElement("label",{htmlFor:"geoSearch",className:""},t("look-for-an-application"))),React.createElement("div",{className:"col-lg-13",style:devmode?{}:{display:"none"}},React.createElement("div",null,React.createElement(GeoMultiSelect2Component,{className:"form-control",ref:"geoSearch",onChange:this.search,name:"geoSearch"})),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"text",className:"form-control",onChange:this.fullTextSearchChanged,placeholder:t("keywords"),name:"fullTextSearch"}),React.createElement("span",{className:"input-group-btn"},React.createElement("button",{className:"btn btn-default",type:"button",onClick:this.search},React.createElement("img",{className:"btn-search",src:"/img/icon/btn-search.png"}))))),React.createElement("div",{className:"checkbox"},React.createElement("label",null,React.createElement("input",{type:"checkbox",checked:this.props.filter.audience.citizens,onChange:this.change("audience","citizens")}),t("citizens"))),React.createElement("div",{className:"checkbox"},React.createElement("label",null,React.createElement("input",{type:"checkbox",checked:this.props.filter.audience.publicbodies,onChange:this.change("audience","publicbodies")}),t("publicbodies"))),React.createElement("div",{className:"checkbox"},React.createElement("label",null,React.createElement("input",{type:"checkbox",checked:this.props.filter.audience.companies,onChange:this.change("audience","companies")}),t("companies"))),React.createElement("div",null),React.createElement("div",{className:"checkbox"},React.createElement("label",null,React.createElement("input",{type:"checkbox",checked:this.props.filter.payment.free,onChange:this.change("payment","free")}),t("free"))),React.createElement("div",{className:"checkbox"},React.createElement("label",null,React.createElement("input",{type:"checkbox",checked:this.props.filter.payment.paid,onChange:this.change("payment","paid")}),t("paid"))))},renderOldLanguageDropdown:function(){return React.createElement("div",{className:""},React.createElement("ul",{className:"nav navbar-nav"},React.createElement("li",{className:""},React.createElement("label",{htmlFor:"searchLocale",className:""},t("languages-supported-by-applications"))),React.createElement("li",{className:"dropdown dropdown-lang search-locale",name:"searchLocale"},React.createElement("a",{style:{color:"#636884",fontSize:"18px"},href:"#",className:"dropdown-toggle","data-toggle":"dropdown"},React.createElement("span",null,t(this.state.selectedLanguage)),React.createElement("i",{className:"caret"})),React.createElement("ul",{className:"dropdown-menu"},languageComponents))))}}),AppList=React.createClass({displayName:"AppList",render:function(){var apps=this.props.apps.map(function(app){return React.createElement(App,{key:app.id,app:app})}.bind(this));return React.createElement("div",{className:"col-md-8 app-store-result"},apps)}}),LoadMore=React.createClass({displayName:"LoadMore",render:function(){var loading=null;return this.props.loading?loading=React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fa fa-spinner fa-spin"})," ",t("ui.loading")):this.props.maybeMoreApps&&(loading=React.createElement("div",{className:"text-center"},React.createElement("button",{className:"btn btn-primary",onClick:this.props.loadMoreApps},"Load more"))),React.createElement("div",{className:"col-md-8 col-md-offset-4"},loading)}}),App=React.createClass({displayName:"App",componentDidMount:function(){this.props.app.isDefault&&this.openApp()},openApp:function(){this.refs.appmodal.open()},render:function(){var indicatorStatus=this.props.app.installed?"installed":this.props.app.paid?"paid":"free",pubServiceIndicator=this.props.app.public_service?React.createElement("div",{className:"public-service-indicator"},React.createElement("div",{className:"triangle"}),React.createElement("div",{className:"label"},React.createElement("i",{className:"triangle fa fa-institution"}))):null;return React.createElement("div",null,React.createElement(AppModal,{ref:"appmodal",app:this.props.app}),React.createElement("div",{className:"hit text-center",onClick:this.openApp},pubServiceIndicator,React.createElement("img",{src:this.props.app.icon}),React.createElement("p",{className:"appname"},this.props.app.name),React.createElement("div",{className:"caption"},React.createElement("p",null,this.props.app.provider),React.createElement("p",{className:"appdescription"},this.props.app.description)),React.createElement(Indicator,{status:indicatorStatus})))}}),Indicator=React.createClass({displayName:"Indicator",render:function(){var btns,status=this.props.status;return btns="installed"==status?[React.createElement("button",{key:"indicator_button",className:"btn btn-indicator btn-indicator-installed"},t("installed")),React.createElement("button",{key:"indicator_icon",className:"btn btn-indicator btn-indicator-installed-icon"},React.createElement("i",{className:"fa fa-check"}))]:"free"==status?[React.createElement("button",{key:"indication_button",className:"btn btn-indicator btn-indicator-available"},t("free"))]:[React.createElement("button",{key:"indicator_button",className:"btn btn-indicator btn-indicator-available"},t("paid")),React.createElement("button",{key:"indicator_icon",className:"btn btn-indicator btn-indicator-available-icon"},React.createElement("i",{className:"fa fa-eur"}))],React.createElement("div",{className:"btn-group indicator"},btns)}}),AppModal=React.createClass({displayName:"AppModal",getInitialState:function(){return{app:{rating:0,rateable:!0,tos:"",policy:"",longdescription:"",screenshots:null},orgs:[],createOrg:!1,buying:!1,error:!1}},componentDidMount:function(){$(this.refs.modal.getDOMNode()).on("hide.bs.modal",function(){history.pushState({},"store",store_root)}.bind(this))},loadApp:function(){$.ajax({url:store_service+"/details/"+this.props.app.type+"/"+this.props.app.id,type:"get",dataType:"json",success:function(data){var state=this.state;state.app=data,this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)})},loadOrgs:function(){$.ajax({url:store_service+"/organizations/"+this.props.app.type+"/"+this.props.app.id,type:"get",dataType:"json",success:function(data){var state=this.state;state.orgs=data,this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)})},open:function(){this.setState(this.getInitialState());var href=store_root+"/"+this.props.app.type+"/"+this.props.app.id;"function"==typeof history.pushState&&history.pushState({},"application",href),this.loadApp(),logged_in&&this.loadOrgs(),this.refs.modal.open()},installApp:function(organization){var state=this.state;state.buying=!0,this.setState(state);var request={appId:this.props.app.id,appType:this.props.app.type};organization&&(request.organizationId=organization),$.ajax({url:store_service+"/buy",type:"post",data:JSON.stringify(request),contentType:"application/json",success:function(data){if(data.success)window.location="/my/dashboard";else{var state=this.state;state.buying=!1,state.error=!0,this.setState(state)}}.bind(this),error:function(xhr,status,err){var state=this.state;state.buying=!1,this.setState(state)}.bind(this)})},createNewOrg:function(){var state=this.state;state.createOrg=!0,this.setState(state)},orgCreated:function(org){var state=this.state;state.createOrg=!1,org&&this.installApp(org.id),this.setState(state)},doCreateOrg:function(){this.refs.createOrgForm&&this.refs.createOrgForm.saveOrganization()},cancelCreateOrg:function(){var state=this.state;state.createOrg=!1,this.setState(state)},rateApp:function(rate){$.ajax({url:store_service+"/rate/"+this.props.app.type+"/"+this.props.app.id,type:"post",contentType:"application/json",data:JSON.stringify({rate:rate}),success:function(){var state=this.state;state.app.rateable=!1,state.app.rating=rate,this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)})},componentDidUpdate:function(){var desc=$(this.getDOMNode()).find(".app-description table");desc.addClass("table table-bordered table-condensed table-striped")},renderAppDescription:function(){var rateInfo,carousel=this.state.app.screenshots&&this.state.app.screenshots.length>0?React.createElement("div",{className:"row"},React.createElement(Carousel,{images:this.state.app.screenshots})):null,error=this.state.error?React.createElement("div",{className:"alert alert-danger alert-dismissible",role:"alert"},React.createElement("button",{type:"button",className:"close","data-dismiss":"alert"},React.createElement("span",{"aria-hidden":"true"},"Ã—"),React.createElement("span",{className:"sr-only"},t("ui.close"))),React.createElement("strong",null,t("sorry"))," ",t("could-not-install-app")):null;rateInfo=logged_in?this.state.app.rateable?null:React.createElement("p",null,t("already-rated")):null;var description=converter.makeHtml(this.state.app.longdescription);return React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-1"},React.createElement("img",{src:this.props.app.icon,alt:this.props.app.name})),React.createElement("div",{className:"col-sm-7"},React.createElement("div",null,React.createElement("p",{className:"appname"},this.props.app.name),React.createElement("p",null,t("by")," ",this.props.app.provider))),React.createElement("div",{className:"col-sm-4 center-container install-application"},React.createElement(InstallButton,{app:this.props.app,orgs:this.state.orgs,url:this.state.app.serviceUrl,installApp:this.installApp,createNewOrg:this.createNewOrg}))),React.createElement("div",{className:"row"},React.createElement(Rating,{rating:this.state.app.rating,rateable:this.state.app.rateable,rate:this.rateApp}),rateInfo),error,carousel,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-6 app-description",dangerouslySetInnerHTML:{__html:description}}),React.createElement("div",{className:"col-md-6"},React.createElement("p",null,t("agree-to-tos")),React.createElement("p",null,React.createElement("a",{href:this.state.app.tos,target:"_new"},t("tos"))),React.createElement("p",null,React.createElement("a",{href:this.state.app.policy,target:"_new"},t("privacy"))))))},orgTypeRestriction:function(){return{company:this.props.app.target_companies,public_body:this.props.app.target_publicbodies}},renderCreateNew:function(){return React.createElement("div",null,React.createElement("h3",null,t("create-new-org")),React.createElement(CreateOrganizationForm,{ref:"createOrgForm",successHandler:this.orgCreated,typeRestriction:this.orgTypeRestriction()}),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-4 col-sm-offset-8"},React.createElement("a",{className:"btn btn-default",onClick:this.cancelCreateOrg},t("ui.cancel")),React.createElement("a",{className:"btn btn-primary",onClick:this.doCreateOrg},t("create")))))},renderBuying:function(){return React.createElement("h3",null,React.createElement("i",{className:"fa fa-spinner fa-spin"})," ",t("buying"))},render:function(){var content=null;return content=this.state.buying?this.renderBuying():this.state.createOrg?this.renderCreateNew():this.renderAppDescription(),React.createElement(Modal,{ref:"modal",large:!0,infobox:!0,title:this.props.app.name},content)}}),InstallButton=React.createClass({displayName:"InstallButton",onlyForCitizens:function(){return this.props.app.target_citizens&&!this.props.app.target_companies&&!this.props.app.target_publicbodies},hasCitizens:function(){return this.props.app.target_citizens},componentDidMount:function(){this.onlyForCitizens()||($("#install").popover({content:$("#install-app-popover").html(),html:!0,placement:"bottom",trigger:"click"}),$(this.getDOMNode()).find("button[data-toggle='dropdown']").dropdown())},installApp:function(event){event.preventDefault(),this.props.installApp()},installAppForOrganization:function(orgId){return function(event){event.preventDefault(),this.props.installApp(orgId)}.bind(this)},render:function(){if(logged_in){if("service"==this.props.app.type)return this.props.app.installed?this.props.url?React.createElement("a",{className:"btn btn-primary",href:this.props.url,target:"_new"},t("launch")):React.createElement("a",{className:"btn btn-primary"},React.createElement("i",{className:"fa fa-spinner fa-spin"})):React.createElement("a",{className:"btn btn-primary",href:"#",onClick:this.installApp},t("install"));var installForSelf=null;this.hasCitizens()&&(installForSelf=React.createElement("button",{type:"button",className:"btn btn-default",onClick:this.installApp},t("for_myself")));var installOnBehalf=null;if(!this.onlyForCitizens()){var organizations=this.props.orgs.map(function(org){return React.createElement("li",{key:org.id},React.createElement("a",{href:"#",onClick:this.installAppForOrganization(org.id)},org.name))}.bind(this));installOnBehalf=[React.createElement("button",{key:"behalfButton",type:"button",className:"btn btn-default","data-toggle":"dropdown"},t("on_behalf_of"),React.createElement("span",{className:"caret"})),React.createElement("ul",{key:"behalfMenu",className:"dropdown-menu",role:"menu"},organizations,React.createElement("li",null,React.createElement("a",{href:"#",onClick:this.props.createNewOrg},t("create-new-org"))))]}return React.createElement(MyPop,{className:"btn btn-primary",label:t("install")},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-2"},React.createElement("img",{src:image_root+"my/app-store.png"})),React.createElement("div",{className:"col-sm-10"},React.createElement("h4",null,t("install_this_app")),React.createElement("p",null,t("confirm-install-this-app")),this.props.app.paid?React.createElement("p",null,t("confirm-install-this-app-paid")):null,installForSelf,installOnBehalf)))}return React.createElement("a",{className:"btn btn-primary-inverse",href:store_root+"/login?appId="+this.props.app.id+"&appType="+this.props.app.type},t("install"))}}),Carousel=React.createClass({displayName:"Carousel",getInitialState:function(){return{index:0}},back:function(){var index=this.state.index;index=Math.max(0,index-1),this.setState({index:index})},forward:function(){var index=this.state.index;index=Math.min(this.props.images.length,index+1),this.setState({index:index})},render:function(){if(!this.props.images)return null;var back=null;this.state.index>0&&(back=React.createElement("a",{className:"back",onClick:this.back},React.createElement("i",{className:"fa fa-chevron-left"})));var forward=null;return this.state.index<this.props.images.length-1&&(forward=React.createElement("a",{className:"forward",onClick:this.forward},React.createElement("i",{className:"fa fa-chevron-right"}))),React.createElement("div",{className:"carousel"},back,React.createElement("img",{src:this.props.images[this.state.index],alt:this.state.index}),forward)}}),Rating=React.createClass({displayName:"Rating",getInitialState:function(){return{}},startEditing:function(){this.props.rateable&&this.setState({editing:!0,rating:0})},stopEditing:function(){this.setState({editing:!1,rating:0})},rate:function(){this.props.rateable&&this.props.rate(this.state.rating)},mouseMove:function(event){if(this.state.editing){var rect=this.getDOMNode().getBoundingClientRect(),x=Math.floor(8*(event.clientX-rect.left)/rect.width)/2;rect.right-event.clientX<5&&(x=4),this.setState({editing:!0,rating:x})}},render:function(){var className,rating;rating=this.state.editing?this.state.rating:this.props.rating;var rt=1>rating?"0"+10*rating:10*rating;return className="rating-static rating-"+rt,React.createElement("div",{className:className,onMouseEnter:this.startEditing,onMouseLeave:this.stopEditing,onMouseMove:this.mouseMove,onClick:this.rate})}});React.renderComponent(React.createElement(AppStore,null),document.getElementById("store"));