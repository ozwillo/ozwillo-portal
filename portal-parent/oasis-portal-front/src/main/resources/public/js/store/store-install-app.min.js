var AppModal=React.createClass({displayName:"AppModal",getInitialState:function(){return{app:{rating:0,rateable:!0,tos:"",policy:"",longdescription:"",screenshots:null},orgs:[],selectedOrg:jQuery.extend(!0,{},default_org_data.organization),createOrg:!1,buying:!1,installing:!1,isInstalled:!1,error:!1}},componentDidMount:function(){$(this.refs.modal.getDOMNode()).on("hide.bs.modal",function(event){history.pushState({},"store",store_root)}.bind(this))},componentDidUpdate:function(){var desc=$(this.getDOMNode()).find(".app-description table");desc.addClass("table table-bordered table-condensed table-striped")},loadApp:function(){$.ajax({url:store_service+"/details/"+this.props.app.type+"/"+this.props.app.id,type:"get",dataType:"json",success:function(data){var state=this.state;state.app=data,this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)})},loadOrgs:function(){$.ajax({url:store_service+"/organizations/"+this.props.app.type+"/"+this.props.app.id,type:"get",dataType:"json",success:function(data){var state=this.state;state.orgs=data,this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)})},open:function(){this.setState(this.getInitialState());var href=store_root+"/"+this.props.app.type+"/"+this.props.app.id;"function"==typeof history.pushState&&history.pushState({},"application",href),this.loadApp(),logged_in&&this.loadOrgs(),this.refs.modal.open()},close:function(){this.state.isInstalled&&(window.location="/my/dashboard")},doInstallApp:function(organization,updateUserData){var state=this.state;state.installing=!1,state.buying=!0,this.setState(state);var request;updateUserData?(request=updateUserData,request.appId=this.props.app.id,request.appType=this.props.app.type):request={appId:this.props.app.id,appType:this.props.app.type},organization&&(request.organizationId=organization),$.ajax({url:store_service+"/buy",type:"post",data:JSON.stringify(request),contentType:"application/json",success:function(data){if(data.success)this.displaySucessfulInstallForm();else{var state=this.state;state.buying=!1,state.error=!0,this.setState(state)}}.bind(this),error:function(xhr,status,err){var state=this.state;state.buying=!1,this.setState(state)}.bind(this)})},orgCreated:function(org){var state=this.state;state.createOrg=!1,org&&this.doInstallApp(org.id),this.setState(state)},doCreateOrg:function(){this.refs.tabbedForm&&this.refs.tabbedForm.createOrModifOrg()},cancelCreateOrg:function(){var state=this.state;state.createOrg=!1,this.setState(state)},rateApp:function(rate){$.ajax({url:store_service+"/rate/"+this.props.app.type+"/"+this.props.app.id,type:"post",contentType:"application/json",data:JSON.stringify({rate:rate}),success:function(){var state=this.state;state.app.rateable=!1,state.app.rating=rate,this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)})},displayInstallForm:function(){var state=this.state;state.installing=!0,this.setState(state)},displaySucessfulInstallForm:function(){var state=this.state;state.buying=!1,state.isInstalled=!0,this.setState(state)},continueInstallProcess:function(){var state=this.state;state.installType=this.refs.instalForm.getInstallType();var installData=this.refs.instalForm.getInstallData();if("ORG"===state.installType){var orgSearchData=this.refs.instalForm.getOrgSearchData();orgSearchData.contact_name=installData.contact.contact_name,orgSearchData.contact_lastname=installData.contact.contact_lastname,orgSearchData.contact_email=installData.contact.contact_email,state.selectedOrg.typeInstallOrg=orgSearchData.typeInstallOrg,"NEW-ORGS"===orgSearchData.typeInstallOrg?$.ajax({url:network_service+"/search-organization",type:"get",contentType:"json",data:orgSearchData,success:function(data){data&&!data.exist&&data.sector_type===orgSearchData.sector_type&&data.tax_reg_num===orgSearchData.tax_reg_num&&data.legal_name===orgSearchData.legal_name?(state.installing=!1,state.createOrg=!0,state.selectedOrg=data,state.errors=[],this.setState(state)):(this.refs.modalError.open(),this.setState(state))}.bind(this),error:function(xhr,status,err){var state=this.state;state.errors=["general"],this.setState(state)}.bind(this)}):(state.installing=!1,this.doInstallApp(orgSearchData.selectedOrgId,orgSearchData))}else{var orgSearchData=this.refs.instalForm.state.installData.address;orgSearchData.contact_name=installData.contact.contact_name,orgSearchData.contact_lastname=installData.contact.contact_lastname,orgSearchData.contact_email=installData.contact.contact_email,this.doInstallApp(null,orgSearchData)}},orgTypeRestriction:function(){return{company:this.props.app.target_companies,public_body:this.props.app.target_publicbodies}},renderCreateNewOrganization:function(){return React.createElement("div",null,React.createElement("h3",null,this.state.selectedOrg.exist?t("modify-org"):t("create-new-org")),React.createElement(CreateOrModifyOrganizationForm,{ref:"tabbedForm",successHandler:this.orgCreated,typeRestriction:this.orgTypeRestriction(),organization:this.state.selectedOrg}),React.createElement("div",{className:"col-sm-4 col-sm-offset-8"},React.createElement("a",{className:"btn btn-default",onClick:this.cancelCreateOrg},t("ui.cancel")),React.createElement("a",{className:"btn btn-primary",onClick:this.doCreateOrg},t("create"))))},renderBuying:function(){return React.createElement("h3",null," ",React.createElement("i",{className:"fa fa-spinner fa-spin"})," ",t("buying"))},renderInstallingForm:function(){return React.createElement(InstallForm,{ref:"instalForm",installApp:this.installApp,url:this.state.app.serviceUrl,app:this.props.app,orgs:this.state.orgs,continueInstallProcess:this.continueInstallProcess})},renderAppDescription:function(){return React.createElement(AppDescriptionComponent,{app:this.props.app,stateApp:this.state.app,rateApp:this.rateApp,onInstallButton:this.displayInstallForm,error:this.state.error})},renderSucessfulInstallationForm:function(){return React.createElement("div",null,React.createElement("div",{className:"form-horizontal"},React.createElement("i",{id:"success-app-install",className:"fa fa-check pull-left col-sm-offset-1"}),React.createElement("div",{className:"form-group"},React.createElement("h5",{className:"col-sm-offset-2"},t("install.org.success-msg-1")),React.createElement("br",null)),this.props.app.paid?React.createElement("div",{className:"form-group"},React.createElement("h5",{className:"col-sm-offset-2"},t("install.org.success-msg-2")),React.createElement("br",null)):"","PERSONAL"===this.state.installType?"":React.createElement("div",{className:"form-group"},React.createElement("h5",{className:"col-sm-offset-2"},t("install.org.success-msg-3")),React.createElement("br",null)),React.createElement("div",{className:"form-group"},React.createElement("h5",{className:"col-sm-offset-2"},t("install.org.success-msg-4")),React.createElement("br",null))))},render:function(){var content=null;return content=this.state.buying?this.renderBuying():this.state.createOrg?this.renderCreateNewOrganization():this.state.installing?this.renderInstallingForm():this.state.isInstalled?this.renderSucessfulInstallationForm():this.renderAppDescription(),React.createElement("div",null,React.createElement(Modal,{ref:"modal",large:!0,infobox:!0,title:this.props.app.name,cancelHandler:this.close},content),React.createElement(Modal,{ref:"modalError",title:t("ui.something_went_wrong_title"),infobox:!0,cancelHandler:null},React.createElement("div",null,React.createElement("h5",null,t("search.organization.cannot-be-used")))))}}),converter=new Showdown.converter({extensions:["table"]}),AppDescriptionComponent=React.createClass({displayName:"AppDescriptionComponent",render:function(){var stateApp=this.props.stateApp,carousel=stateApp.screenshots&&stateApp.screenshots.length>0?React.createElement("div",{className:"row"},React.createElement(Carousel,{images:stateApp.screenshots})):null,error=this.props.error?React.createElement("div",{className:"alert alert-danger alert-dismissible",role:"alert"},React.createElement("button",{type:"button",className:"close","data-dismiss":"alert"},React.createElement("span",{"aria-hidden":"true"},"×"),React.createElement("span",{className:"sr-only"},t("ui.close"))),React.createElement("strong",null,t("sorry"))," ",t("could-not-install-app")):null,rateInfo=null;logged_in&&!stateApp.rateable&&(rateInfo=React.createElement("p",null,t("already-rated")));var launchOrInstallButton,description=converter.makeHtml(stateApp.longdescription);if("service"==this.props.app.type&&this.props.app.installed)launchOrInstallButton=this.props.stateApp&&this.props.stateApp.serviceUrl?React.createElement("a",{className:"btn btn-primary",href:this.props.stateApp.serviceUrl,target:"_new"},t("launch")):React.createElement("label",null," ",React.createElement("i",{className:"fa fa-spinner fa-spin"})," ");else{var installButton=logged_in?React.createElement("button",{className:"btn btn-primary",onClick:this.props.onInstallButton},t("install")):React.createElement("a",{className:"btn btn-primary-inverse",href:store_root+"/login?appId="+this.props.app.id+"&appType="+this.props.app.type},t("install"));launchOrInstallButton=installButton}return React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-1"},React.createElement("img",{src:this.props.app.icon,alt:this.props.app.name})),React.createElement("div",{className:"col-sm-7"},React.createElement("div",null,React.createElement("p",{className:"appname"},this.props.app.name),React.createElement("p",null,t("by")," ",this.props.app.provider))),React.createElement("div",{className:"col-sm-4 center-container install-application"},launchOrInstallButton)),React.createElement("div",{className:"row"},React.createElement(Rating,{rating:stateApp.rating,rateable:stateApp.rateable,rate:this.props.rateApp}),rateInfo),error,carousel,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-6 app-description",dangerouslySetInnerHTML:{__html:description}}),React.createElement("div",{className:"col-md-6"},React.createElement("p",null,t("agree-to-tos")),React.createElement("p",null,React.createElement("a",{href:stateApp.tos,target:"_new"},t("tos"))),React.createElement("p",null,React.createElement("a",{href:stateApp.policy,target:"_new"},t("privacy"))))))}}),InstallForm=React.createClass({displayName:"InstallForm",getInitialState:function(){return this.getProfileInfo(),{installType:"PERSONAL",errors:[],installData:{contact:{contact_name:"",contact_lastname:"",contact_email:""},address:{exist:!1,street_and_number:"",additional_address_field:"",city:"",zip:"",country_uri:"",cedex:"",po_box:""}}}},getProfileInfo:function(){$.ajax({url:network_service+"/general-user-info",type:"get",contentType:"json",success:function(data){var state=this.state;state.installData.contact.contact_name=data.user_name,state.installData.contact.contact_lastname=data.user_lastname,state.installData.contact.contact_email=data.user_email,data.address&&(state.installData.address.street_and_number=data.address.street_address,state.installData.address.city=data.address.locality,state.installData.address.zip=data.address.postal_code,state.installData.address.country=data.address.country),this.setState(state)}.bind(this),error:function(xhr,status,err){}.bind(this)})},getInstallType:function(){var installTypeRestrictions={personal:this.hasCitizens(),org:this.hasOrganizations()};return"PERSONAL"===this.state.installType&&installTypeRestrictions.personal===!1?"ORG":"ORG"===this.state.installType&&installTypeRestrictions.org===!1?"PERSONAL":this.state.installType},getInstallData:function(){return this.state.installData},getOrgSearchData:function(){return this.refs.setOrgComponent.getOrgSearchData()},isOnlyForCitizens:function(){return this.props.app.target_citizens&&!this.props.app.target_companies&&!this.props.app.target_publicbodies},hasCitizens:function(){return this.props.app.target_citizens},hasOrganizations:function(){return this.props.app.target_companies||this.props.app.target_publicbodies},toggleType:function(event){var installType=this.state.installType;installType=event.target.value,this.setState({installType:installType})},renderInstallType:function(){var installTypeRestrictions={personal:this.hasCitizens(),org:this.hasOrganizations()},installType=this.getInstallType(),personal=installTypeRestrictions.personal?React.createElement("div",{className:"radio col-sm-offset-2"},"  ",React.createElement("label",null,React.createElement("input",{type:"radio",value:"PERSONAL",checked:"PERSONAL"==installType,onChange:this.toggleType},t("install.org.type.PERSONAL"))),"  "):null,org=installTypeRestrictions.org?React.createElement("div",{className:"radio col-sm-offset-2"},"  ",React.createElement("label",null,React.createElement("input",{type:"radio",value:"ORG",checked:"ORG"==installType,onChange:this.toggleType},t("install.org.type.ORG"))),"  "):null,sectorTypeClassName="col-sm-3 control-label ";return sectorTypeClassName=-1!=$.inArray("sector_type",this.props.errors)?sectorTypeClassName+" error":sectorTypeClassName,React.createElement("div",{className:"form-group"},personal,org)},renderLabel:function(htmlFor,class_name,label){var cn=-1!=$.inArray(class_name,this.state.errors)?"col-sm-3 control-label error":"col-sm-3 control-label";return React.createElement("label",{htmlFor:htmlFor,className:cn},label,React.createElement("label",{className:"error"},"*"))},changeInputContact:function(fieldname){return function(event){var org=this.state.installData;org.contact[fieldname]=event.target.value,this.setState({installData:org,errors:[]})}.bind(this)},changeInputAddress:function(fieldname,value,isNumericField){var org=this.state.installData;isNumericField&&""!==value?org.address[fieldname]=isInteger(value)?value.trim():org.address[fieldname]:org.address[fieldname]=value,this.setState({installData:org,errors:[]})},validateContact:function(){var errs=[],contact=this.state.installData.contact;return contact.contact_name&&""!=contact.contact_name.trim()||errs.push("name"),contact.contact_lastname&&""!=contact.contact_lastname.trim()||errs.push("lastname"),contact.contact_email&&""!=contact.contact_email.trim()||errs.push("email"),this.setState({errors:errs}),errs.length>0?!1:!0},validateAddress:function(){var errs=this.state.errors,address=this.state.installData.address;return address.city_uri&&""!=address.city.trim()||(errs.push("city_uri"),errs.push("city")),address.zip&&""!=address.zip.trim()||errs.push("zip"),address.country_uri&&""!=address.country_uri.trim()||errs.push("country_uri"),this.setState({errors:errs}),errs.length>0?!1:!0},validateAndContinue:function(){var installType=this.getInstallType();"PERSONAL"===installType?this.validateContact()&&this.validateAddress()&&this.props.continueInstallProcess():"ORG"===installType&&this.validateContact()&&this.refs.setOrgComponent&&this.refs.setOrgComponent.validate()&&this.props.continueInstallProcess()},render:function(){var installType=this.getInstallType();return React.createElement("div",{className:"form-horizontal"},this.renderInstallType(),React.createElement("h4",null,t("search.contact.title")),React.createElement(ContactSearchFormControl,{renderLabel:this.renderLabel,orgSearchData:this.state.installData.contact,changeInput:this.changeInputContact}),"PERSONAL"===installType||"service"===this.props.app.type?React.createElement("div",null,React.createElement("h4",null,t("search.contact.address.title")),React.createElement(AddressComponent,{ref:"addressComponent",errors:this.state.errors,addressContainer:this.state.installData.address,changeInput:this.changeInputAddress})):React.createElement("div",null,React.createElement("h4",null,t("search.organization.title")),React.createElement(SetOrganizationComponent,{ref:"setOrgComponent",url:this.props.url,app:this.props.app,orgs:this.props.orgs,isOnlyForCitizens:this.isOnlyForCitizens,onChangeSelectedOrg:this.onChangeSelectedOrg})),React.createElement("a",{className:"btn btn-primary pull-right",onClick:this.validateAndContinue},t("ui.next")))}});SetOrganizationComponent=React.createClass({displayName:"SetOrganizationComponent",getInitialState:function(){return{orgSearchData:{contact_name:"",contact_lastname:"",contact_email:"",sector_type:"",country:"France",legal_name:"",tax_reg_num:"",typeInstallOrg:"NEW-ORGS",selectedOrgId:""},errors:[]}},getOrgSearchData:function(){return this.state.orgSearchData},orgTypeRestriction:function(){return{company:this.props.app.target_companies,public_body:this.props.app.target_publicbodies}},onChangeOrgInput:function(fieldname){return function(event){var org=this.state.orgSearchData;"country"===fieldname?(org[fieldname+"_uri"]=event.target.value,org[fieldname]=event.target.selectedOptions[0].label):org[fieldname]=event.target.value,this.setState({orgSearchData:org,errors:[]})}.bind(this)},toggleInstallOrgType:function(event){var org=this.state.orgSearchData;org.typeInstallOrg=event.target.value,org.selectedOrgId=this.props.orgs[0].id,this.setState({orgSearchData:org,errors:[]})},toggleSectorType:function(event){var org=this.state.orgSearchData;org.sector_type=event.target.value,this.setState({orgSearchData:org,errors:[]})},renderOrganizations:function(){var opts=[];return this.props.orgs.map(function(org){opts.push(React.createElement("option",{key:org.id,className:"action-select-option",value:org.id},org.name))}.bind(this)),React.createElement("select",{className:"btn btn-default dropdown-toggle",onChange:this.onChangeOrgInput("selectedOrg")},opts)},validate:function(){var state=this.state,errors=[],orgSearchData=state.orgSearchData;return"EXISTING-ORGS"===orgSearchData.typeInstallOrg?""===orgSearchData.selectedOrgId.trim()&&errors.push("typeInstallOrg"):(orgSearchData.sector_type&&""!=orgSearchData.sector_type.trim()||errors.push("sector_type"),orgSearchData.country_uri&&""!=orgSearchData.country_uri.trim()||errors.push("country"),orgSearchData.legal_name&&""!=orgSearchData.legal_name.trim()||errors.push("legal_name"),orgSearchData.tax_reg_num&&""!=orgSearchData.tax_reg_num.trim()||errors.push("tax_reg_num")),state.errors=errors,this.setState(state),state.errors.length>0?!1:!0},renderLabel:function(htmlFor,class_name,label){var cn=-1!=$.inArray(class_name,this.state.errors)?"col-sm-3 control-label error":"col-sm-3 control-label";return React.createElement("label",{htmlFor:htmlFor,className:cn},label,React.createElement("label",{className:"error"},"*"))},render:function(){return React.createElement("div",{className:"form-group"},!this.props.isOnlyForCitizens()&&this.props.orgs&&this.props.orgs.length>0?React.createElement("div",{className:"radio col-sm-offset-2"},React.createElement("label",null,React.createElement("input",{type:"radio",value:"EXISTING-ORGS",checked:"EXISTING-ORGS"==this.state.orgSearchData.typeInstallOrg,onChange:this.toggleInstallOrgType}),t("search.organization.selection.existing"),"    "),this.renderOrganizations()):"",React.createElement("div",{className:"radio col-sm-offset-2"},React.createElement("label",null,React.createElement("input",{type:"radio",value:"NEW-ORGS",checked:"NEW-ORGS"==this.state.orgSearchData.typeInstallOrg,onChange:this.toggleInstallOrgType}),t("search.organization.selection.new")),React.createElement(OrganizationSearchFormControl,{errors:this.state.errors,renderLabel:this.renderLabel,typeRestriction:this.orgTypeRestriction(),orgSearchData:this.state.orgSearchData,changeInput:this.onChangeOrgInput,toggleType:this.toggleSectorType})))}});var Carousel=React.createClass({displayName:"Carousel",getInitialState:function(){return{index:0}},back:function(){var index=this.state.index;index=Math.max(0,index-1),this.setState({index:index})},forward:function(){var index=this.state.index;index=Math.min(this.props.images.length,index+1),this.setState({index:index})},render:function(){if(!this.props.images)return null;var back=null;this.state.index>0&&(back=React.createElement("a",{className:"back",onClick:this.back},React.createElement("i",{className:"fa fa-chevron-left"})));var forward=null;return this.state.index<this.props.images.length-1&&(forward=React.createElement("a",{className:"forward",onClick:this.forward},React.createElement("i",{className:"fa fa-chevron-right"}))),React.createElement("div",{className:"carousel"},back,React.createElement("img",{src:this.props.images[this.state.index],alt:this.state.index}),forward)}}),Rating=React.createClass({displayName:"Rating",getInitialState:function(){return{}},startEditing:function(){this.props.rateable&&this.setState({editing:!0,rating:0})},stopEditing:function(){this.setState({editing:!1,rating:0})},rate:function(){this.props.rateable&&this.props.rate(this.state.rating)},mouseMove:function(event){if(this.state.editing){var rect=this.getDOMNode().getBoundingClientRect(),x=Math.floor(8*(event.clientX-rect.left)/rect.width)/2;rect.right-event.clientX<5&&(x=4),this.setState({editing:!0,rating:x})}},render:function(){var className,rating;rating=this.state.editing?this.state.rating:this.props.rating;var rt=1>rating?"0"+10*rating:10*rating;return className="rating-static rating-"+rt,React.createElement("div",{className:className,onMouseEnter:this.startEditing,onMouseLeave:this.stopEditing,onMouseMove:this.mouseMove,onClick:this.rate})}});
